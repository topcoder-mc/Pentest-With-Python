"""
    - Created by topcoder-mc (MJ-Ghasempour) at Jul 07/2020

    - All rigth of this project is reserved for hacktor-team 
        http://hacktor.co

    - this package create connector to mysql database
"""

from mysql.connector import (
    connect as mysql_connect,
    Error as mysql_error
)


class MySqlContext:

    def __init__(self, config_manager):
        self.config_manager = config_manager

    def connect_to_db(self) -> object:
        """ with this function we try to connect to mysql database
            :return: connection object
        """
        try:
            self.connection = mysql_connect(
                host=self.config_manager.get.DataBase.MySql.Host,
                database=self.config_manager.get.DataBase.MySql.Database,
                user=self.config_manager.get.DataBase.MySql.User,
                password=self.config_manager.get.DataBase.MySql.Passwd
            )

            if self.connection.is_connected():
                print("[+] MySql Connection Open Successfully")
                self.__init_db__(self.connection)
                return self.connection
            else:
                raise "We have error for connecting to database !!!"

        except mysql_error as error:
            self.connection = mysql_connect(
                host=self.config_manager.get.DataBase.MySql.Host,
                database="mysql",
                user=self.config_manager.get.DataBase.MySql.User,
                password=self.config_manager.get.DataBase.MySql.Passwd
            )
            self.__init_db__(self.connection)
            self.connection.close()
            del self.connection
            return self.connect_to_db()


    def close_db(self):
        """ close existing connection 
            :return:
        """
        if self.connection.is_connected():
            self.connection.close()
            print("\n[-] MySql Connection Close successfully\n")

    def __init_db__(self, connection):

        cursor = connection.cursor()        
        
        # with this below code we create database of our attack if it's not exist in the database
        cursor.execute(f"""
            CREATE DATABASE IF NOT EXISTS {self.config_manager.get.DataBase.MySql.Database};
        """)
        
        # create user table in database 
        cursor.execute(f"""
            create table if not exists users (
                id int not null auto_increment,
                username nvarchar(100) not null UNIQUE,
                password nvarchar(100) not null,
                isadmin bit,
                isdeleted bit,
                email nvarchar(100) not null UNIQUE,
                primary key (id)
            );
        """)

        # create news table in database 
        cursor.execute(f"""
            create table if not exists news (
                id int not null auto_increment,
                title nvarchar(200) not null,
                description text not null,
                isdeleted bit,
                primary key (id)
            );
        """)

        sql_select_Query = "SELECT EXISTS (SELECT 1 FROM users);"
        cursor.execute(sql_select_Query)
        records = cursor.fetchall()
        if records[0][0] == 0:
            self.__insert_data__(cursor, connection)

        connection.commit()
        cursor.close()

    @staticmethod
    def __insert_data__(cursor, connection):
        
        # adding user to database 
        cursor.execute("""
            insert into users (username, password, isadmin, isdeleted, email) values
            ("admin", "123qwe", 1, 0, "admin@info.com")
        """)
        cursor.execute("""
            insert into users (username, password, isadmin, isdeleted, email) values
            ("test", "123qwe3", 0, 0, "test@info.com")
        """)
        cursor.execute("""
            insert into users (username, password, isadmin, isdeleted, email) values
            ("mj", "123qwe4", 0, 0, "mj@info.com")
        """)

        # adding news to database 
        cursor.execute("""
            insert into news (title, description, isdeleted) values
            ("Hacking from zero", "New session of hacking is started", 0)
        """)
        cursor.execute("""
            insert into news (title, description, isdeleted) values
            ("Hacking with python", "New session of hacking is started with python scripting", 0)
        """)
